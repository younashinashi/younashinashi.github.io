env:
  FILE: data/releases/vaulta.json

steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Ensure jq & path
    run: |
      sudo apt-get update -y
      sudo apt-get install -y jq
      mkdir -p data/releases
      if [ ! -f "$FILE" ]; then echo "[]" > "$FILE"; fi
      echo "Existing file:"
      head -n 30 "$FILE" || true

  - name: Validate inputs
    shell: bash
    run: |
      OP="${{ inputs.op }}"
      TAG="${{ inputs.tag }}"
      INDEX="${{ inputs.index }}"
      VN="${{ inputs.version_name }}"
      VC="${{ inputs.version_code }}"

      if [ "$OP" = "add" ]; then
        if [ -z "$VN" ] || [ -z "$VC" ]; then
          echo "❌ add には version_name と version_code が必要です"; exit 1
        fi
      fi

      if [ "$OP" = "update" ] || [ "$OP" = "delete" ]; then
        if [ -z "$TAG" ] && [ -z "$INDEX" ]; then
          echo "❌ ${OP} には tag か index のどちらかが必要です"; exit 1
        fi
      fi
      echo "✅ inputs OK"

  - name: Do ADD / UPDATE / DELETE
    id: do
    shell: bash
    run: |
      OP="${{ inputs.op }}"
      TAG="${{ inputs.tag }}"
      INDEX="${{ inputs.index }}"
      VN="${{ inputs.version_name }}"
      VC="${{ inputs.version_code }}"
      TITLE_IN="${{ inputs.title }}"
      BODY_IN='${{ toJSON(inputs.body) }}'
      HTML_URL="${{ inputs.html_url }}"
      PUBLISHED_AT="${{ inputs.published_at }}"

      to_null_or_str() { if [ -z "$1" ]; then echo "null"; else printf '%s\n' "$(jq -Rn --arg v "$1" '$v')" ; fi; }
      TITLE_JSON=$(to_null_or_str "$TITLE_IN")
      HTML_JSON=$(to_null_or_str "$HTML_URL")
      PUBAT_JSON=$(to_null_or_str "$PUBLISHED_AT")

      if [ "$OP" = "add" ]; then
        if ! echo "$VC" | grep -Eq '^[0-9]+$'; then echo "❌ version_code は整数で"; exit 1; fi
        TAG_NEW="v${VN}+${VC}"
        NOW_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        TITLE_EFF=${TITLE_IN:-"Vaulta ${VN}"}
        PUB_EFF=${PUBLISHED_AT:-$NOW_UTC}

        jq -n --arg tag "$TAG_NEW" \
              --arg vn "$VN" \
              --argjson vc "$VC" \
              --arg title "$TITLE_EFF" \
              --argjson body "$BODY_IN" \
              --arg html "$HTML_URL" \
              --arg pub "$PUB_EFF" \
          '{
            tag: $tag,
            versionName: $vn,
            versionCode: $vc,
            title: $title,
            body: $body,
            htmlUrl: $html,
            publishedAt: $pub
          }' > new.json

        tmp=$(mktemp)
        jq --argjson new "$(cat new.json)" '. as $old | [$new] + $old' "$FILE" > "$tmp"
        mv "$tmp" "$FILE"
        echo "::set-output name=changed::true"
        echo "✅ Added: $TAG_NEW"
        head -n 30 "$FILE"

      elif [ "$OP" = "update" ]; then
        tmp=$(mktemp)
        if [ -n "$TAG" ]; then
          jq --arg tag "$TAG" \
             --arg vn "$VN" \
             --argjson vc "$( [ -n "$VC" ] && echo "$VC" || echo null )" \
             --argjson title "$TITLE_JSON" \
             --argjson body "$BODY_IN" \
             --argjson html "$HTML_JSON" \
             --argjson pub "$PUBAT_JSON" '
            map(
              if .tag == $tag then
                . as $o
                | {
                    tag: $o.tag,
                    versionName: (if $vn != "" then $vn else $o.versionName end),
                    versionCode: (if $vc != null then $vc else $o.versionCode end),
                    title: (if $title != null then $title else $o.title end),
                    body: (if $body != null then $body else $o.body end),
                    htmlUrl: (if $html != null then $html else $o.htmlUrl end),
                    publishedAt: (if $pub != null then $pub else $o.publishedAt end)
                  }
              else .
              end
            )' "$FILE" > "$tmp"
        else
          if ! echo "$INDEX" | grep -Eq '^[0-9]+$'; then echo "❌ index は整数で"; exit 1; fi
          jq --argjson idx "$INDEX" \
             --arg vn "$VN" \
             --argjson vc "$( [ -n "$VC" ] && echo "$VC" || echo null )" \
             --argjson title "$TITLE_JSON" \
             --argjson body "$BODY_IN" \
             --argjson html "$HTML_JSON" \
             --argjson pub "$PUBAT_JSON" '
            to_entries
            | .[$idx] as $t?
            | if $t == null then
                error("index範囲外")
              else
                (.[$idx].value) as $o
                | .[$idx].value = {
                    tag: $o.tag,
                    versionName: (if $vn != "" then $vn else $o.versionName end),
                    versionCode: (if $vc != null then $vc else $o.versionCode end),
                    title: (if $title != null then $title else $o.title end),
                    body: (if $body != null then $body else $o.body end),
                    htmlUrl: (if $html != null then $html else $o.htmlUrl end),
                    publishedAt: (if $pub != null then $pub else $o.publishedAt end)
                  }
                | from_entries
              end
            ' "$FILE" > "$tmp"
        fi
        mv "$tmp" "$FILE"
        echo "::set-output name=changed::true"
        echo "✅ Updated."
        head -n 30 "$FILE"

      elif [ "$OP" = "delete" ]; then
        tmp=$(mktemp)
        if [ -n "$TAG" ]; then
          jq --arg tag "$TAG" 'map(select(.tag != $tag))' "$FILE" > "$tmp"
        else
          if ! echo "$INDEX" | grep -Eq '^[0-9]+$'; then echo "❌ index は整数で"; exit 1; fi
          jq --argjson idx "$INDEX" 'to_entries | del(.[ $idx ]) | from_entries' "$FILE" > "$tmp"
        fi
        mv "$tmp" "$FILE"
        echo "::set-output name=changed::true"
        echo "✅ Deleted."
        head -n 30 "$FILE"
      else
        echo "❌ 未知の op: $OP"; exit 1
      fi

  - name: Commit & Push
    if: steps.do.outputs.changed == 'true'
    run: |
      git config user.name "release-bot"
      git config user.email "actions@users.noreply.github.com"
      git add "$FILE"
      git commit -m "${{ inputs.op }} Vaulta release entry"
      git push
