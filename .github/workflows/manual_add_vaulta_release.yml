name: Manage Vaulta Releases (Add/Update/Delete)

on:
  workflow_dispatch:
    inputs:
      op:
        description: "操作: add / update / delete"
        required: true
        default: "add"
      tag:
        description: "対象のtag（例: v2.23.0+173）※update/delete時に推奨"
        required: false
      index:
        description: "対象index（0始まり・任意）"
        required: false
      version_name:
        description: "例: 2.23.0（add時は必須）"
        required: false
      version_code:
        description: "例: 173（add時は必須）"
        required: false
      title:
        description: "未入力時は 'Vaulta <version_name>' を自動設定"
        required: false
      body:
        description: "本文（Markdown可・複数行OK）"
        required: false
      html_url:
        description: "GitHub Release のURLなど（任意）"
        required: false
      published_at:
        description: "ISO日時（未入力時は現在UTC）。例: 2025-11-03T12:34:56Z"
        required: false

jobs:
  manage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      FILE: data/releases/vaulta.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure jq & path
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p data/releases
          if [ ! -f "$FILE" ]; then echo "[]" > "$FILE"; fi
          echo "[INFO] 現在の $FILE 先頭30行:"
          head -n 30 "$FILE" || true

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          OP="${{ inputs.op }}"
          TAG="${{ inputs.tag }}"
          INDEX="${{ inputs.index }}"
          VN="${{ inputs.version_name }}"
          VC="${{ inputs.version_code }}"

          echo "[INFO] Validate inputs: op=$OP tag=$TAG index=$INDEX vn=$VN vc=$VC"

          if [ "$OP" = "add" ]; then
            if [ -z "$VN" ] || [ -z "$VC" ]; then
              echo "❌ add には version_name と version_code が必要です"; exit 1
            fi
          fi

          if [ "$OP" = "update" ] || [ "$OP" = "delete" ]; then
            if [ -z "$TAG" ] && [ -z "$INDEX" ]; then
              echo "❌ ${OP} には tag か index のどちらかが必要です"; exit 1
            fi
          fi
          echo "✅ inputs OK"

      - name: Do ADD / UPDATE / DELETE
        id: do
        shell: bash
        run: |
          set -euo pipefail

          OP="${{ inputs.op }}"
          TAG="${{ inputs.tag }}"
          INDEX="${{ inputs.index }}"
          VN="${{ inputs.version_name }}"
          VC="${{ inputs.version_code }}"
          TITLE_IN="${{ inputs.title }}"
          HTML_URL="${{ inputs.html_url }}"
          PUBLISHED_AT="${{ inputs.published_at }}"

          echo "[INFO] OP=$OP TAG=$TAG INDEX=$INDEX"
          echo "[INFO] VN=$VN VC=$VC"
          echo "[INFO] TITLE_IN=$TITLE_IN"
          echo "[INFO] HTML_URL=$HTML_URL"
          echo "[INFO] PUBLISHED_AT=$PUBLISHED_AT"

          # BODY は GITHUB_EVENT_PATH から安全に取得（複数行対応）
          if [ -z "${GITHUB_EVENT_PATH:-}" ]; then
            echo "❌ GITHUB_EVENT_PATH が未設定です"; exit 1
          fi
          # Windows 由来の \r を削除して、改行コードを LF に統一
          BODY_IN="$(jq -r '.inputs.body // ""' "$GITHUB_EVENT_PATH" | tr -d '\r')"

          if [ -n "$BODY_IN" ]; then
            HAS_BODY="true"
            echo "[INFO] BODY が入力されました（複数行対応）"
          else
            HAS_BODY="false"
            echo "[INFO] BODY 入力なし（update の場合は既存値を維持）"
          fi

          # 空文字なら null、それ以外は JSON 文字列に変換するヘルパ
          to_null_or_str() {
            if [ -z "$1" ]; then
              echo "null"
            else
              # jq で安全にクォートした JSON 文字列を返す
              printf '%s\n' "$(jq -Rn --arg v "$1" '$v')"
            fi
          }

          TITLE_JSON=$(to_null_or_str "$TITLE_IN")
          HTML_JSON=$(to_null_or_str "$HTML_URL")
          PUBAT_JSON=$(to_null_or_str "$PUBLISHED_AT")

          if [ "$OP" = "add" ]; then
            if ! echo "$VC" | grep -Eq '^[0-9]+$'; then
              echo "❌ version_code は整数で"; exit 1
            fi

            TAG_NEW="v${VN}+${VC}"
            NOW_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            TITLE_EFF=${TITLE_IN:-"Vaulta ${VN}"}
            PUB_EFF=${PUBLISHED_AT:-$NOW_UTC}

            echo "[INFO] 追加する tag: $TAG_NEW"
            echo "[INFO] 追加する publishedAt: $PUB_EFF"

            jq -n --arg tag "$TAG_NEW" \
                  --arg vn "$VN" \
                  --argjson vc "$VC" \
                  --arg title "$TITLE_EFF" \
                  --arg body "$BODY_IN" \
                  --arg html "$HTML_URL" \
                  --arg pub "$PUB_EFF" \
              '{
                tag: $tag,
                versionName: $vn,
                versionCode: $vc,
                title: $title,
                body: $body,
                htmlUrl: $html,
                publishedAt: $pub
              }' > new.json

            tmp=$(mktemp)
            jq --argjson new "$(cat new.json)" '. as $old | [$new] + $old' "$FILE" > "$tmp"
            mv "$tmp" "$FILE"

            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "✅ Added: $TAG_NEW"
            head -n 30 "$FILE"

          elif [ "$OP" = "update" ]; then
            tmp=$(mktemp)

            if [ -n "$TAG" ]; then
              jq --arg tag "$TAG" \
                 --arg vn "$VN" \
                 --argjson vc "$( [ -n "$VC" ] && echo "$VC" || echo null )" \
                 --argjson title "$TITLE_JSON" \
                 --arg body "$BODY_IN" \
                 --argjson html "$HTML_JSON" \
                 --argjson pub "$PUBAT_JSON" \
                 --arg hasBody "$HAS_BODY" '
                map(
                  if .tag == $tag then
                    . as $o
                    | {
                        tag: $o.tag,
                        versionName: (if $vn != "" then $vn else $o.versionName end),
                        versionCode: (if $vc != null then $vc else $o.versionCode end),
                        title: (if $title != null then $title else $o.title end),
                        body: (if $hasBody == "true" then $body else $o.body end),
                        htmlUrl: (if $html != null then $html else $o.htmlUrl end),
                        publishedAt: (if $pub != null then $pub else $o.publishedAt end)
                      }
                  else .
                  end
                )' "$FILE" > "$tmp"
            else
              if ! echo "$INDEX" | grep -Eq '^[0-9]+$'; then
                echo "❌ index は整数で"; exit 1
              fi

              jq --argjson idx "$INDEX" \
                 --arg vn "$VN" \
                 --argjson vc "$( [ -n "$VC" ] && echo "$VC" || echo null )" \
                 --argjson title "$TITLE_JSON" \
                 --arg body "$BODY_IN" \
                 --argjson html "$HTML_JSON" \
                 --argjson pub "$PUBAT_JSON" \
                 --arg hasBody "$HAS_BODY" '
                to_entries
                | .[$idx] as $t?
                | if $t == null then
                    error("index範囲外")
                  else
                    (.[$idx].value) as $o
                    | .[$idx].value = {
                        tag: $o.tag,
                        versionName: (if $vn != "" then $vn else $o.versionName end),
                        versionCode: (if $vc != null then $vc else $o.versionCode end),
                        title: (if $title != null then $title else $o.title end),
                        body: (if $hasBody == "true" then $body else $o.body end),
                        htmlUrl: (if $html != null then $html else $o.htmlUrl end),
                        publishedAt: (if $pub != null then $pub else $o.publishedAt end)
                      }
                    | from_entries
                  end
                ' "$FILE" > "$tmp"
            fi

            mv "$tmp" "$FILE"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "✅ Updated."
            head -n 30 "$FILE"

          elif [ "$OP" = "delete" ]; then
            tmp=$(mktemp)
            if [ -n "$TAG" ]; then
              jq --arg tag "$TAG" 'map(select(.tag != $tag))' "$FILE" > "$tmp"
            else
              if ! echo "$INDEX" | grep -Eq '^[0-9]+$'; then
                echo "❌ index は整数で"; exit 1
              fi
              jq --argjson idx "$INDEX" \
                 'to_entries | del(.[ $idx ]) | from_entries' "$FILE" > "$tmp"
            fi

            mv "$tmp" "$FILE"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "✅ Deleted."
            head -n 30 "$FILE"

          else
            echo "❌ 未知の op: $OP"; exit 1
          fi

      - name: Commit & Push
        if: steps.do.outputs.changed == 'true'
        run: |
          set -euo pipefail
          git config user.name "release-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "$FILE"
          git commit -m "${{ inputs.op }} Vaulta release entry"
          git push
