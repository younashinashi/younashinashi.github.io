name: Manual Add Vaulta Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "例: 2.23.0"
        required: true
      version_code:
        description: "例: 173"
        required: true
      title:
        description: "未入力なら『Vaulta <version_name>』になります"
        required: false
      body:
        description: "リリースノート（Markdown可・複数行OK）"
        required: true
      html_url:
        description: "GitHub Release のURL（任意）"
        required: false

jobs:
  add:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ← このリポ内へコミットするために必要

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Prepare payload
        id: prep
        shell: bash
        run: |
          TAG="v${{ inputs.version_name }}+${{ inputs.version_code }}"
          TITLE="${{ inputs.title }}"
          if [ -z "$TITLE" ]; then TITLE="Vaulta ${{ inputs.version_name }}"; fi
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > new.json <<JSON
          {
            "tag": "$TAG",
            "versionName": "${{ inputs.version_name }}",
            "versionCode": ${{ inputs.version_code }},
            "title": "$TITLE",
            "body": ${{ toJSON(inputs.body) }},
            "htmlUrl": "${{ inputs.html_url }}",
            "publishedAt": "$NOW"
          }
          JSON

          echo "payload=$(tr -d '\n' < new.json)" >> $GITHUB_OUTPUT
          echo "===== New entry ====="
          cat new.json

      - name: Prepend to data/releases/vaulta.json
        shell: bash
        run: |
          FILE="data/releases/vaulta.json"
          if [ ! -f "$FILE" ]; then echo "[]">$FILE; fi
          tmp=$(mktemp)
          jq --argjson new '${{ steps.prep.outputs.payload }}' '. as $old | [$new] + $old' "$FILE" > "$tmp"
          mv "$tmp" "$FILE"
          echo "===== Preview (head) ====="
          head -n 30 "$FILE"

      - name: Commit & Push
        run: |
          git config user.name "release-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/releases/vaulta.json
          git commit -m "Add Vaulta release: v${{ inputs.version_name }}+${{ inputs.version_code }}"
          git push
